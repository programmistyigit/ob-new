# Qidiruv Tizimi Arxitekturasi

## 1ï¸âƒ£ Umumiy Arxitektura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    User Request                              â”‚
â”‚              (API/Bot command/Direct call)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Search Service Layer      â”‚
         â”‚  (advancedSearch.ts /       â”‚
         â”‚   contextSearch.ts)         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  getAllActiveUserIds()      â”‚
         â”‚  (runUserBot.ts)            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   activeClients Map         â”‚
         â”‚   userId â†’ TelegramClient   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client 1      â”‚          â”‚  Client N      â”‚
â”‚  (User 123)    â”‚   ...    â”‚  (User 999)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Telegram API   â”‚          â”‚ Telegram API   â”‚
â”‚ (GramJS)       â”‚          â”‚ (GramJS)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Search Results â”‚          â”‚ Search Results â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Aggregate & Filter        â”‚
         â”‚   (Combine all results)     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Return to User            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2ï¸âƒ£ Advanced Search Flow (Media & Chat qidiruv)

```
Request: searchAcrossAllClients(target, options)
   â”‚
   â”œâ”€ Step 1: Get all active client IDs
   â”‚  â””â”€> getAllActiveUserIds() â†’ [123, 456, 789, ...]
   â”‚
   â”œâ”€ Step 2: Loop through each client (PARALLEL)
   â”‚  â”‚
   â”‚  â”œâ”€ Client 123:
   â”‚  â”‚  â”œâ”€ Get TelegramClient from activeClients Map
   â”‚  â”‚  â”œâ”€ Resolve target (phone/userId/id â†’ Entity)
   â”‚  â”‚  â”‚  â””â”€> client.getEntity(target) â†’ User/Chat object
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ If options.media:
   â”‚  â”‚  â”‚  â”œâ”€ client.iterMessages(targetUser) â†’ ALL MESSAGES âœ…
   â”‚  â”‚  â”‚  â”œâ”€ Filter messages by media type:
   â”‚  â”‚  â”‚  â”‚  â”œâ”€ message.photo â†’ images[]
   â”‚  â”‚  â”‚  â”‚  â”œâ”€ message.video â†’ videos[]
   â”‚  â”‚  â”‚  â”‚  â””â”€ message.audio â†’ audios[]
   â”‚  â”‚  â”‚  â””â”€ Extract metadata:
   â”‚  â”‚  â”‚     â”œâ”€ action: out/input (message.out)
   â”‚  â”‚  â”‚     â”œâ”€ fileName, mimeType, size
   â”‚  â”‚  â”‚     â””â”€ date, messageId
   â”‚  â”‚  â”‚
   â”‚  â”‚  â””â”€ If options.chats:
   â”‚  â”‚     â”œâ”€ client.iterMessages(targetUser) â†’ ALL MESSAGES âœ…
   â”‚  â”‚     â””â”€ Map to ChatMessage format:
   â”‚  â”‚        â”œâ”€ path: user/otherUser
   â”‚  â”‚        â”œâ”€ message text
   â”‚  â”‚        â””â”€ date, messageId
   â”‚  â”‚
   â”‚  â”œâ”€ Client 456: (same process)
   â”‚  â””â”€ Client 789: (same process)
   â”‚
   â”œâ”€ Step 3: Aggregate results
   â”‚  â””â”€> Filter out empty results
   â”‚
   â””â”€ Step 4: Return
      â””â”€> [{user, userId, data}, ...]
```

---

## 3ï¸âƒ£ Context Search Flow (Matn bo'yicha qidiruv)

```
Request: searchByContext({query, userIds, limit})
   â”‚
   â”œâ”€ Step 1: Get specified clients (or all)
   â”‚  â””â”€> userIds â†’ [123, 456]
   â”‚
   â”œâ”€ Step 2: For each client (PARALLEL)
   â”‚  â”‚
   â”‚  â”œâ”€ Client 123:
   â”‚  â”‚  â”œâ”€ Get TelegramClient from activeClients Map
   â”‚  â”‚  â”œâ”€ client.getDialogs({}) â†’ ALL DIALOGS âœ…
   â”‚  â”‚  â”‚  â””â”€> [Dialog1, Dialog2, Dialog3, ...]
   â”‚  â”‚  â”‚
   â”‚  â”‚  â”œâ”€ For each dialog:
   â”‚  â”‚  â”‚  â”œâ”€ Get dialog info (name, type, id)
   â”‚  â”‚  â”‚  â”œâ”€ client.iterMessages(dialog) â†’ ALL MESSAGES âœ…
   â”‚  â”‚  â”‚  â”‚
   â”‚  â”‚  â”‚  â”œâ”€ For each message:
   â”‚  â”‚  â”‚  â”‚  â”œâ”€ Check if text matches query
   â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ Case sensitive/insensitive
   â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€ Exact/substring match
   â”‚  â”‚  â”‚  â”‚  â”‚
   â”‚  â”‚  â”‚  â”‚  â””â”€ If match found:
   â”‚  â”‚  â”‚  â”‚     â”œâ”€ Get before context:
   â”‚  â”‚  â”‚  â”‚     â”‚  â””â”€> messages[i-3...i-1]
   â”‚  â”‚  â”‚  â”‚     â”œâ”€ Get after context:
   â”‚  â”‚  â”‚  â”‚     â”‚  â””â”€> messages[i+1...i+3]
   â”‚  â”‚  â”‚  â”‚     â”œâ”€ Get sender info
   â”‚  â”‚  â”‚  â”‚     â””â”€ Add to matches[]
   â”‚  â”‚  â”‚  â”‚
   â”‚  â”‚  â”‚  â””â”€ Continue to next message
   â”‚  â”‚  â”‚
   â”‚  â”‚  â””â”€ Return all matches for this client
   â”‚  â”‚
   â”‚  â””â”€ Client 456: (same process)
   â”‚
   â”œâ”€ Step 3: Filter non-empty results
   â”‚  â””â”€> Keep only clients with matches
   â”‚
   â””â”€ Step 4: Return
      â””â”€> [{userId, username, matches[], totalMatches}, ...]
```

---

## 4ï¸âƒ£ Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  activeClients   â”‚ â—„â”€â”€â”€ In-Memory (RAM)
â”‚  Map<id, client> â”‚      RUNTIME ONLY
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ getActiveClient(userId)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TelegramClient   â”‚
â”‚  - connect()     â”‚
â”‚  - getEntity()   â”‚
â”‚  - getMessages() â”‚
â”‚  - getDialogs()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ API Request
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Telegram API    â”‚ â—„â”€â”€â”€ Network call
â”‚  (MTProto)       â”‚      EXTERNAL
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Response
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Raw Data        â”‚
â”‚  - Messages      â”‚
â”‚  - Media         â”‚
â”‚  - Users         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Transform
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Formatted       â”‚ â—„â”€â”€â”€ TypeScript interfaces
â”‚  SearchResult    â”‚      TYPE-SAFE
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5ï¸âƒ£ Key Components Interaction

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Application Startup                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Load sessions from disk (user_X.json files)         â”‚
â”‚  2. Create TelegramClient for each session              â”‚
â”‚  3. Store in activeClients Map                          â”‚
â”‚  4. Setup event handlers (archiveHandler)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Runtime State                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  activeClients Map:                                      â”‚
â”‚  â”œâ”€ 123456789 â†’ TelegramClient (Connected, Listening)   â”‚
â”‚  â”œâ”€ 987654321 â†’ TelegramClient (Connected, Listening)   â”‚
â”‚  â””â”€ 111222333 â†’ TelegramClient (Connected, Listening)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Search Services (On-Demand)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚AdvancedSearch   â”‚        â”‚ ContextSearch    â”‚        â”‚
â”‚  â”‚  Service        â”‚        â”‚   Service        â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚           â”‚                          â”‚                   â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                      â”‚                                   â”‚
â”‚              Use activeClients                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
             Query Telegram API
             (No database needed)
```

---

## 6ï¸âƒ£ Memory vs Disk Storage

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    DISK (Persistent) â”‚   MEMORY (Runtime)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ session files:       â”‚ activeClients Map:       â”‚
â”‚  user_123.json       â”‚  123 â†’ TelegramClient    â”‚
â”‚  user_456.json       â”‚  456 â†’ TelegramClient    â”‚
â”‚  user_789.json       â”‚  789 â†’ TelegramClient    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Contains:            â”‚ Contains:                â”‚
â”‚  - sessionString     â”‚  - Live connection       â”‚
â”‚  - createdAt         â”‚  - Event handlers        â”‚
â”‚  - lastUsed          â”‚  - API methods           â”‚
â”‚  - phoneNumber       â”‚  - State                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Persists after:      â”‚ Lost after:              â”‚
â”‚  âœ… Server restart   â”‚  âŒ Server restart       â”‚
â”‚  âœ… App crash        â”‚  âŒ App crash            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Used for:            â”‚ Used for:                â”‚
â”‚  - Login/Auth        â”‚  - Active operations     â”‚
â”‚  - Session recovery  â”‚  - Real-time messaging   â”‚
â”‚  - Reconnection      â”‚  - Search queries        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7ï¸âƒ£ Search Performance Model

```
Scenario: 3 active clients, search for @Begzod's images

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sequential (OLD - Not used)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Client 1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (2s)                         â”‚
â”‚ Client 2:         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (2s)                 â”‚
â”‚ Client 3:                 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (2s)         â”‚
â”‚ Total: 6 seconds                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Parallel (CURRENT - Used)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Client 1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (2s)                         â”‚
â”‚ Client 2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (2s)                         â”‚
â”‚ Client 3: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (2s)                         â”‚
â”‚ Total: 2 seconds âœ… 3x faster!                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8ï¸âƒ£ Error Handling Flow

```
Request â†’ Service
   â”‚
   â”œâ”€ Try: Get client from activeClients
   â”‚  â”œâ”€ âœ… Success â†’ Continue
   â”‚  â””â”€ âŒ Not found â†’ Skip this client, log warning
   â”‚
   â”œâ”€ Try: Resolve target entity
   â”‚  â”œâ”€ âœ… Found â†’ Continue
   â”‚  â””â”€ âŒ Not found â†’ Skip this client, log debug
   â”‚
   â”œâ”€ Try: Fetch messages
   â”‚  â”œâ”€ âœ… Success â†’ Process
   â”‚  â””â”€ âŒ API error â†’ Skip, log error
   â”‚
   â””â”€ Return: Only successful results
      â””â”€> No crash on partial failures âœ…
```

---

## 9ï¸âƒ£ Code Structure

```
src/
â”œâ”€ services/
â”‚  â”œâ”€ advancedSearch.ts     â† Media/Chat search logic
â”‚  â”œâ”€ contextSearch.ts      â† Text search with context
â”‚  â”œâ”€ index.ts              â† Exports
â”‚  â””â”€ examples.ts           â† Usage examples
â”‚
â”œâ”€ userbot/
â”‚  â”œâ”€ runUserBot.ts         â† activeClients management
â”‚  â”‚  â”œâ”€ activeClients Map
â”‚  â”‚  â”œâ”€ getActiveClient()
â”‚  â”‚  â”œâ”€ getAllActiveClients()
â”‚  â”‚  â””â”€ getAllActiveUserIds()
â”‚  â”‚
â”‚  â””â”€ login/
â”‚     â””â”€ sessionStore.ts    â† Disk storage
â”‚
â””â”€ utils/
   â””â”€ logger.ts             â† Logging
```

---

## ğŸ”Ÿ Execution Timeline

```
T=0:  User calls searchAcrossAllClients()
      â”‚
T=1:  Get all active client IDs
      â”‚  getAllActiveUserIds() â†’ [123, 456, 789]
      â”‚
T=2:  Start parallel searches (Promise.all)
      â”œâ”€ Search in Client 123 â”€â”€â”€â”
      â”œâ”€ Search in Client 456 â”€â”€â”€â”¤ (Parallel)
      â””â”€ Search in Client 789 â”€â”€â”€â”˜
      â”‚
T=4:  All searches complete
      â”‚  Aggregate results
      â”‚
T=5:  Filter & format
      â”‚
T=6:  Return to user
```

---

## Key Advantages:

âœ… **On-Demand:** Faqat chaqirilganda ishlaydi, doimiy resource sarflamaydi
âœ… **Parallel:** Barcha clientlar bir vaqtda qidiradi (tez)
âœ… **Scalable:** 1000 ta client bo'lsa ham ishlaydi
âœ… **Isolated:** Bir clientdagi error boshqalarga ta'sir qilmaydi
âœ… **No Database:** To'g'ridan-to'g'ri Telegram API dan oladi (har doim yangi)
âœ… **Type-Safe:** TypeScript interfeyslari bilan xavfsiz
âœ… **Flexible:** Target 3 xil formatda (phone/userId/id)
âœ… **Rich Results:** Metadata bilan to'liq ma'lumot
