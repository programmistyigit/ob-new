# Multi-Source Media Search (3-Layer Search)

## üéØ Umumiy Tushuncha

Media qidiruv tizimi **3 ta manbadan** ham ma'lumot to'playdi:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           Media Search Request                   ‚îÇ
‚îÇ        (target: @Begzod, media: {img: true})     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  PARALLEL SEARCH ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ           ‚îÇ           ‚îÇ
     ‚ñº           ‚ñº           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Source 1‚îÇ ‚îÇ Source 2‚îÇ ‚îÇ Source 3‚îÇ
‚îÇ Direct  ‚îÇ ‚îÇArchive  ‚îÇ ‚îÇArchive  ‚îÇ
‚îÇMessages ‚îÇ ‚îÇDatabase ‚îÇ ‚îÇChannels ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ           ‚îÇ           ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ Aggregated Results   ‚îÇ
      ‚îÇ (Deduplicated)       ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìä Uchta Manba:

### **1. Direct Messages (To'g'ridan-to'g'ri messagelar)**

**Qayerdan:**
- Telegram API: `client.iterMessages(targetUser)`
- To'g'ri PM (Private Message) chat

**Qanday ma'lumot:**
- ‚úÖ Hozirgi mavjud messagelar
- ‚úÖ O'chirilmagan media
- ‚úÖ Real-time ma'lumot

**Metadata:**
- `source: 'direct'`
- fileName, mimeType, size, date, messageId
- action (out/input)

---

### **2. Archive Database (Arxiv ma'lumotlar bazasi)**

**Qayerdan:**
- MongoDB: `Archive` collection
- Faqat **TARGET_IDs** uchun

**Qanday ma'lumot:**
- ‚úÖ O'chirilgan messagelar (agar arxivlangan bo'lsa)
- ‚úÖ Ephemeral media metadata
- ‚úÖ Permanent storage path
- ‚úÖ Forward status

**Metadata:**
- `source: 'archive_db'`
- fileName, mimeType, size, date, messageId
- **metadata.forwarded** - Forward qilingan/yo'q
- **metadata.ephemeral** - View-once media
- **metadata.localPath** - Disk da saqlangan yo'l
- **metadata.archivedBy** - Kim arxivlagan
- **metadata.text** - Message matni (agar bor bo'lsa)

**Query:**
```typescript
Archive.find({
  $or: [
    { user_id: myId, other_id: targetId },
    { user_id: targetId, other_id: myId },
  ],
  'media': { $exists: true, $ne: null }
})
```

---

### **3. Archive Channels (Shaxsiy arxiv kanallar)**

**Qayerdan:**
- Private Telegram Channels
- `UserChannel` collection (channel_id, access_hash)

**Qanday ma'lumot:**
- ‚úÖ Barcha arxivlangan media
- ‚úÖ Forward qilingan va manual yuborilganlar
- ‚úÖ Caption ma'lumotlari

**Metadata:**
- `source: 'archive_channel'`
- fileName, mimeType, size, date, messageId
- **metadata.archivedBy** - Kim arxivlagan
- **metadata.text** - Caption (Direction, With, Time, etc.)

**Kanal topish:**
```typescript
UserChannel.findOne({ user_id: targetId })
```

**Kanal messagelar:**
```typescript
client.iterMessages(channelPeer)
```

---

## üîÑ Search Flow (Qidiruv jarayoni):

```
Step 1: Direct Messages Search
‚îú‚îÄ client.iterMessages(targetUser)
‚îú‚îÄ Filter by media type (img/video/audio)
‚îú‚îÄ Extract metadata
‚îî‚îÄ Add to results with source: 'direct'

Step 2: Archive Database Search
‚îú‚îÄ Archive.find({user_id, other_id, media exists})
‚îú‚îÄ Filter by media type (mimeType/fileName)
‚îú‚îÄ Extract rich metadata (forwarded, ephemeral, localPath)
‚îî‚îÄ Add to results with source: 'archive_db'

Step 3: Archive Channels Search
‚îú‚îÄ UserChannel.findOne({user_id: targetId})
‚îú‚îÄ client.iterMessages(channelPeer)
‚îú‚îÄ Filter by media type
‚îú‚îÄ Parse caption for direction
‚îî‚îÄ Add to results with source: 'archive_channel'

Step 4: Aggregate & Return
‚îî‚îÄ Combine all results (no deduplication - show all sources)
```

---

## üìã Result Structure:

```typescript
{
  user: "alice",
  userId: 123456789,
  data: {
    images: [
      // From direct messages
      {
        action: "out",
        targetName: "Begzod",
        targetId: 987654321,
        fileName: "photo_123.jpg",
        mimeType: "image/jpeg",
        date: "2025-10-15...",
        messageId: 123,
        source: "direct"  // ‚Üê Source indicator
      },
      
      // From archive database
      {
        action: "input",
        targetName: "Begzod",
        targetId: 987654321,
        fileName: "msg_456_ephemeral.jpg",
        mimeType: "image/jpeg",
        size: 52340,
        date: "2025-10-10...",
        messageId: 456,
        source: "archive_db",  // ‚Üê Archive metadata
        metadata: {
          forwarded: false,
          ephemeral: true,  // View-once media!
          localPath: "target_archives/user_123/contact_987/msg_456.jpg",
          archivedBy: 123456789,
          text: "Check this out!"
        }
      },
      
      // From archive channel
      {
        action: "out",
        targetName: "Begzod",
        targetId: 987654321,
        fileName: "photo_789.jpg",
        mimeType: "image/jpeg",
        date: "2025-10-05...",
        messageId: 789,
        source: "archive_channel",  // ‚Üê From private channel
        metadata: {
          archivedBy: 123456789,
          text: "üìù Direction: me->other\nüë§ With: Begzod\nüïí Time: ..."
        }
      }
    ]
  }
}
```

---

## üéØ Use Cases:

### **Scenario 1: O'chirilgan media topish**

```
User o'z PM dan rasmni o'chirdi.

Source 1 (Direct): ‚ùå Yo'q (o'chirilgan)
Source 2 (Archive DB): ‚úÖ Bor (metadata + localPath)
Source 3 (Archive Channel): ‚úÖ Bor (actual media)

Result: Eski rasmni topa oladi! ‚úÖ
```

### **Scenario 2: Ephemeral media (View Once)**

```
User view-once rasm yubordi.

Source 1 (Direct): ‚ùå Yo'q (ephemeral - 1 marta ko'rilgandan keyin yo'qoladi)
Source 2 (Archive DB): ‚úÖ Bor (metadata.ephemeral: true, localPath)
Source 3 (Archive Channel): ‚úÖ Bor (‚ö†Ô∏è EPHEMERAL MEDIA caption bilan)

Result: View-once mediani topadi va metadata ko'rsatadi! ‚úÖ
```

### **Scenario 3: TARGET_ID bo'lmagan user**

```
User TARGET_ID da yo'q.

Source 1 (Direct): ‚úÖ Hozirgi messagelar
Source 2 (Archive DB): ‚ùå Yo'q (faqat TARGET_ID lar uchun)
Source 3 (Archive Channel): ‚úÖ Bor (har kim uchun arxivlanadi)

Result: Partial data (direct + channel) ‚úÖ
```

### **Scenario 4: Boshqa odam arxivida saqlagan**

```
Alice: Begzod bilan muloqot qilgan
Bob: Begzod bilan muloqot qilgan

Alice qidiryapti (target: Begzod):
  Source 1: Alice ‚Üí Begzod direct messages
  Source 2: Alice ‚Üí Begzod archive DB (agar Alice TARGET_ID bo'lsa)
  Source 3: Alice ‚Üí Begzod archive channel (Alice o'zi yaratgan)

Bob qidiryapti (target: Begzod):
  Source 1: Bob ‚Üí Begzod direct messages
  Source 2: Bob ‚Üí Begzod archive DB (agar Bob TARGET_ID bo'lsa)
  Source 3: Bob ‚Üí Begzod archive channel (Bob o'zi yaratgan)

‚úÖ Har bir user o'z arxivini ko'radi
‚úÖ Boshqa odamning arxivi ko'rinmaydi (privacy)
```

---

## üí° Afzalliklar:

### **Comprehensive (To'liq):**
- ‚úÖ Hech narsa miss qilmaydi
- ‚úÖ O'chirilgan media ham topiladi
- ‚úÖ Ephemeral media metadata

### **Privacy-Aware:**
- ‚úÖ Har bir user o'z arxivini ko'radi
- ‚úÖ TARGET_ID tizimi (selective logging)
- ‚úÖ Boshqa odamning ma'lumotlari ko'rinmaydi

### **Rich Metadata:**
- ‚úÖ Source ko'rsatiladi
- ‚úÖ Forward status
- ‚úÖ Local path (agar saqlanganbo'lsa)
- ‚úÖ Archived by (kim arxivlagan)
- ‚úÖ Original text/caption

### **Reliable:**
- ‚úÖ Parallel execution (tez)
- ‚úÖ Error isolation (bir manba xato bo'lsa, boshqalari ishlaydi)
- ‚úÖ Multiple fallbacks

---

## üîç Query Examples:

### **Example 1: Barcha rasmlar**
```typescript
const results = await advancedSearchService.searchAcrossAllClients(
  { userId: '@Begzod' },
  { media: { img: true } }
);

// Returns:
// - Direct PM images
// - Archive DB metadata (if TARGET_ID)
// - Archive channel images
```

### **Example 2: Videolar + Audiolar**
```typescript
const results = await advancedSearchService.searchAcrossAllClients(
  { phoneNumber: '+998901234567' },
  { media: { video: true, audio: true } }
);

// Returns all videos & audios from all 3 sources
```

### **Example 3: Filter by source**
```typescript
const results = await advancedSearchService.searchAcrossAllClients(
  { userId: '@Begzod' },
  { media: { img: true } }
);

// Client-side filtering:
const directOnly = results[0].data.images?.filter(img => img.source === 'direct');
const archivedOnly = results[0].data.images?.filter(img => img.source === 'archive_db');
const channelOnly = results[0].data.images?.filter(img => img.source === 'archive_channel');
```

---

## ‚ö†Ô∏è Important Notes:

### **1. TARGET_ID Dependency:**
- Archive DB faqat TARGET_ID lar uchun
- Agar user TARGET_ID bo'lmasa, Source 2 bo'sh bo'ladi
- Lekin Source 1 va 3 hali ishlaydi

### **2. Privacy:**
- Har bir user faqat o'z arxivini ko'radi
- `UserChannel.findOne({ user_id: targetId })` faqat o'z kanalini topadi
- Boshqa odamning arxiv kanaliga access yo'q

### **3. Performance:**
- 3 ta manba parallel tekshiriladi (tez)
- Archive DB eng tez (indexed MongoDB query)
- Archive Channel o'rtacha (Telegram API)
- Direct Messages ham o'rtacha (Telegram API)

### **4. Deduplication:**
- Hozirda deduplication YO'Q
- Bir media 3 ta joyda ham ko'rinishi mumkin
- Bu feature - user qayerda saqlanganini bilishi uchun

---

## üìä Statistics Example:

```typescript
const results = await advancedSearchService.searchAcrossAllClients(
  { userId: '@Begzod' },
  { media: { img: true, video: true, audio: true } }
);

for (const result of results) {
  const images = result.data.images || [];
  const videos = result.data.videos || [];
  const audios = result.data.audios || [];
  
  console.log(`\nUser: ${result.user}`);
  console.log(`Total Images: ${images.length}`);
  console.log(`  - Direct: ${images.filter(i => i.source === 'direct').length}`);
  console.log(`  - Archive DB: ${images.filter(i => i.source === 'archive_db').length}`);
  console.log(`  - Archive Channel: ${images.filter(i => i.source === 'archive_channel').length}`);
  
  console.log(`Total Videos: ${videos.length}`);
  console.log(`Total Audios: ${audios.length}`);
  
  // Ephemeral media count
  const ephemeralCount = images.filter(i => i.metadata?.ephemeral).length;
  console.log(`Ephemeral Media: ${ephemeralCount}`);
}
```

---

## ‚úÖ Summary:

**3-Layer Search System:**
1. **Direct Messages** - Real-time, current data
2. **Archive Database** - Rich metadata, TARGET_IDs only, deleted messages
3. **Archive Channels** - Full media archive, everyone

**Benefits:**
- üéØ Comprehensive coverage
- üîí Privacy-aware
- üìä Rich metadata
- ‚ö° Parallel execution
- üõ°Ô∏è Error resilient

Endi media qidiruv to'liq va ishonchli! üéâ
